<?php

/**
 * @file
 * Main module.
 */
  use Drupal\qualtricsxm\qualtricsxm;
  use Drupal\Core\Cache;

$secure_embed = !empty(\Drupal::config('qualtricsxm.settings')->get('qualtricsxm_secure_embed')) ? "https://" : "http://";

$embed_base_url = !empty(\Drupal::config('qualtricsxm.settings')->get("qualtricsxm_datacenter")) ?
  $secure_embed . trim(\Drupal::config('qualtricsxm.settings')->get("qualtricsxm_datacenter")) . ".qualtrics.com/jfe/form" :
  $secure_embed . 'survey.qualtrics.com/jfe/form';
$api_token = !empty(\Drupal::config('qualtricsxm.settings')->get('qualtricsxm_api_token')) ? \Drupal::config('qualtricsxm.settings')->get('qualtricsxm_api_token') : "";


define('QUALTRICSXM_BASE_URL', 'https://survey.qualtrics.com/API/v3/');
define('QUALTRICSXM_EMBED_URL', $embed_base_url);
define('QUALTRICSXM_API_TOKEN', $api_token);

/**
 * Implements hook_help().
 */
function qualtricsxm_help() {

}

/**
 * Help function to get the survey responseCounts.
 *
 * @param string $survey_id
 *   ID of the survey to be loaded.
 *
 * @return bool|string
 *   FALSE|Json
 */
function qualtricsxm_count_survey_submissions($survey_id) {
  // Invoke getResponseData API.
  $qualtrics = new Qualtricsxm(QUALTRICSXM_BASE_URL, QUALTRICSXM_API_TOKEN);
  $response_counts = $qualtrics->getSubmissions($survey_id);

  return $response_counts;
}

/**
 * Retrieving the list of surveys from Qualtrics.
 *
 * @return array
 *   List of surveys in array format.
 */
function qualtricsxm_get_surveys() {
  $surveys = &drupal_static(__FUNCTION__);

  if (!isset($surveys)) {
    if ($cache = \Drupal::cache()->get('qualtrics_surveys_list_cache')) {
      $surveys = $cache->data;
    }
    else {
      $qualtrics = new Qualtricsxm(QUALTRICSXM_BASE_URL, QUALTRICSXM_API_TOKEN);
      $surveys_array = $qualtrics->getSurveyList();
      if (!empty($surveys_array)) {
         //Only cache the right data.
        \Drupal::cache()->set('qualtrics_surveys_list_cache', $surveys_array, time() + 60 * 60 * 4);
        $surveys = $surveys_array;
      }
    }
  }
  return $surveys;
}


